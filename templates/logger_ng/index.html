{% extends "layout.html" %}

{% load logger_ng_format %}
{% load forms_tags %}
{% load i18n %}

{% block title %}{% trans "Message Log" %} - {{ block.super }}{% endblock %}

{% block javascripts %}
{% endblock %}


{% block stylesheets %}
    {{ block.super }}
	<script type="text/javascript" src="{{ MEDIA_URL }}logger_ng/js/jquery-1.4.2.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}logger_ng/js/jquery.buildin.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}logger_ng/js/logger_reply.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}logger_ng/js/jquery.buildin.templates.js"></script>

    <link rel="stylesheet" href="{{ MEDIA_URL }}logger_ng/stylesheets/blueprint/screen.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}logger_ng/stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}logger_ng/stylesheets/sms-replies.css" />
{% endblock %}

{% block content %}

<div class="lng_msg span-18 last prepend-2">

    <form action="." method="get" id="logger_ng_search">
        {% csrf_token %}
        <input id="logger_ng_search_box" name="logger_ng_search_box" type="text" value="{{ request.GET.logger_ng_search_box }}" />
        <input type="submit" value="{% trans 'Filter messages' %}" />
    </form>
<ul>
    {% for msg in msgs.object_list %}
    <li class='exchange'>
        <div class="details">
            <span class="date">{{ msg.date|humanize_time_delta }}</span>, 
            {% if msg.is_incoming %} {% trans "from" %} {% else %} {% trans "to" %} {% endif %} 
            <span class="from">{{ msg.ident_string }}</span>
			<span class="status" title="good" />
        </div>
        <div class="msg {% if msg.is_incoming %}text{% else %}response{% endif %}">
            {% if msg.text %}{{ msg.text }}{% else %}[Empty message]{% endif %}
        </div>
        
        {% for response in msg.response.all.reverse %}
            <div class="msg response">
            <span class="date">{{ response.date|humanize_time_delta }}:</span>
            {% if response.text %}{{ response.text }}{% else %}[Empty message]{% endif %}
            </div>
        {% endfor %}
        
        {% if perms.logger_ng.respond and msg.is_incoming %}
            <div class="respond"><form action="." method="post">
                {% csrf_token %}
                <input class="resp_box" name="respond_{{ msg.id }}" type="text" maxlength="140"/>
                <input type="submit" value="{% blocktrans %}Respond{% endblocktrans %}" />
            </form></div>    
        {% endif %}
        
    {% empty %}
        <p>{% trans "No message found" %}<p>    
	</li>
    {% endfor %}
</ul>
</div>

<div class="lng_page span-18 last prepend-2">
<span>
        {% if msgs.has_previous %}
            <a href="?page={{ msgs.previous_page_number }}&amp;logger_ng_search_box={{ request.GET.logger_ng_search_box }}">&lt; {% trans "Previous" %} </a>
        {% endif %}
</span>
            {% blocktrans with msgs.numbe as number and msgs.paginator.num_pages as num_pages %}
                Page {{ number }} of {{ num_pages }}
            {% endblocktrans %}
<span>
        {% if msgs.has_next %}
            <a href="?page={{ msgs.next_page_number }}&amp;logger_ng_search_box={{ request.GET.logger_ng_search_box }}"> {% trans "Next" %} &gt;</a>
        {% endif %}
</span>
</div>

<script type="text/javascript">
	var CurrentLang = (window.navigator.language.toLowerCase()=="en-us") ? "en" : "fr",
		ExchangeSettings = {
		'token' : "qwertyuiopasdfghjklzxcvbnm",
		'msgPOSTurl' : "/messagelog/logger_ng/post_message"
		},
		Translations;

	// window.navigator.language is not reliable in all browsers, but
	// might be good for surprising kevin+renaud with a french ui
	CurrentLang = (window.navigator.language.toLowerCase()=="en-us") ? "en" : "fr";
	
	Translations = {
		'en': {
			'response': "Response",
			'responses': "Responses",
			'reply': 'Respond',
			'status': {
				'good': "Status: Good",
				'warning': "Status: Warning",
				'pending': "Status: Pending",
				'error': "Status: Error",
				'info': "Status: Info"
			},
			'sendMessage': "Send",
			'tooManyCharacters': "Too many characters"
		},
		'fr': {
			'response': "Réponse",
			'responses': "Réponses",
			'reply': "Répondre",
			'status': {
				'good': "Statut: Bon",
				'pending': "Statut: Pending",
				'warning': "Statut: Warning",
				'error': "Statut: Error",
				'info' : "Statut: Info"
			},
			'sendMessage': "Envoyer",
			'tooManyCharacters': "Too many characters (in French)"
		}
	};
	
	(function(){
		//creates the wrapping table with class msgs
		var tableWrap = $("<table class='msgs'></table>");
		
		//creates exchange object and inserts it into tableWrap
		$('.lng_msg li.exchange').enableSmsExchangeIn(tableWrap, ExchangeSettings);
		
		//inserts tableWrap just before the first '.lng_msg'
		$($('.lng_msg').get(0)).before(tableWrap);
		
		//updates list every 5 minutes, must be called after table is populated
//		$.listenForMessages("/logger_ng/latest_messages/", 5 * (1000*60)); 
	})();
</script>

{% endblock %}
